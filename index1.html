<!DOCTYPE html>
<html>
<head>
    <title>Contact Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h2 class="mb-4">ğŸ“ Contact Manager</h2>
    
    <!-- Add/Edit Form -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 id="formTitle" class="mb-0">â• Add New Contact</h5>
        </div>
        <div class="card-body">
            <form id="contactForm">
                <input type="hidden" id="contactId">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="name" placeholder="Enter full name" required>
                        <div class="form-text">Enter the contact's full name</div>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="email" placeholder="Enter email address" required>
                        <div class="form-text">Enter a valid email address</div>
                    </div>
                    <div class="col-12">
                        <label for="message" class="form-label">Message *</label>
                        <textarea class="form-control" id="message" rows="3" placeholder="Enter message or note" required></textarea>
                        <div class="form-text">Add any additional information or notes</div>
                    </div>
                </div>
                <hr>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="bi bi-check-circle"></i> ğŸ’¾ Save Contact
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn" style="display:none">
                        <i class="bi bi-x-circle"></i> âŒ Cancel
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="$('#contactForm')[0].reset()">
                        <i class="bi bi-arrow-clockwise"></i> ğŸ”„ Clear Form
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contacts Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <h5>ğŸ“‹ Contacts List</h5>
            <button class="btn btn-success btn-sm" onclick="loadContacts()">ğŸ”„ Refresh</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Message</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTable">
                        <tr><td colspan="6" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ—‘ï¸ Delete Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <strong id="deleteName"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="successMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="errorMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script>
let editingId = null;
let contactsData = []; // Store contacts data to avoid string escaping issues

// Toast functions
function showToast(message, type = 'success') {
    const toastId = type === 'success' ? '#successToast' : '#errorToast';
    const messageId = type === 'success' ? '#successMessage' : '#errorMessage';
    
    $(messageId).text(message);
    $(toastId).toast('show');
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load contacts on page load
$(document).ready(() => loadContacts());

// Load contacts function
function loadContacts() {
    $('#contactsTable').html('<tr><td colspan="6" class="text-center">Loading...</td></tr>');
    
    $.get('/api/contacts')
        .done(data => {
            contactsData = data; // Store data globally
            let html = '';
            if (data.length === 0) {
                html = '<tr><td colspan="6" class="text-center text-muted">No contacts found</td></tr>';
            } else {
                data.forEach((contact, index) => {
                    const createdDate = contact.created_at ? new Date(contact.created_at).toLocaleDateString() : 'N/A';
                    html += `
                        <tr>
                            <td>${escapeHtml(contact.id.toString())}</td>
                            <td>${escapeHtml(contact.name)}</td>
                            <td>${escapeHtml(contact.email)}</td>
                            <td title="${escapeHtml(contact.message)}">${escapeHtml(contact.message.length > 50 ? contact.message.substring(0, 50) + '...' : contact.message)}</td>
                            <td>${createdDate}</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" onclick="editContact(${index})" title="Edit">âœï¸</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteContact(${index})" title="Delete">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `;
                });
            }
            $('#contactsTable').html(html);
        })
        .fail((xhr, status, error) => {
            console.error('Load contacts error:', xhr.responseText, status, error);
            $('#contactsTable').html('<tr><td colspan="6" class="text-center text-danger">Error loading contacts</td></tr>');
            showToast('âŒ Error loading contacts', 'error');
        });
}

// Save contact (Create/Update)
$('#contactForm').submit(function(e) {
    e.preventDefault();
    
    // Show loading state
    const $saveBtn = $('#saveBtn');
    const originalText = $saveBtn.text();
    $saveBtn.prop('disabled', true).text('ğŸ’¾ Saving...');
    
    const data = {
        name: $('#name').val().trim(),
        email: $('#email').val().trim(),
        message: $('#message').val().trim()
    };
    
    // Validation
    if (!data.name || !data.email || !data.message) {
        showToast('âŒ Please fill all required fields', 'error');
        $saveBtn.prop('disabled', false).text(originalText);
        return;
    }
    
    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
        showToast('âŒ Please enter a valid email address', 'error');
        $saveBtn.prop('disabled', false).text(originalText);
        return;
    }
    
    const method = editingId ? 'PUT' : 'POST';
    const url = editingId ? `/api/contacts/${editingId}` : '/api/contacts';
    
    console.log('Sending request:', { method, url, data });
    
    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: (response) => {
            console.log('Success response:', response);
            resetForm();
            loadContacts();
            showToast(editingId ? 'âœ… Contact updated successfully!' : 'âœ… Contact added successfully!', 'success');
        },
        error: (xhr, status, error) => {
            console.error('Error details:', xhr.responseText, status, error);
            let errorMsg = 'Error saving contact';
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMsg = errorData.error || errorMsg;
            } catch(e) {
                errorMsg = xhr.responseText || error || errorMsg;
            }
            showToast('âŒ ' + errorMsg, 'error');
        },
        complete: () => {
            $saveBtn.prop('disabled', false).text(originalText);
        }
    });
});

// Edit contact - using index instead of inline string parameters
function editContact(index) {
    if (!contactsData[index]) {
        showToast('âŒ Contact not found', 'error');
        return;
    }
    
    const contact = contactsData[index];
    editingId = contact.id;
    $('#contactId').val(contact.id);
    $('#name').val(contact.name);
    $('#email').val(contact.email);
    $('#message').val(contact.message);
    $('#formTitle').text('âœï¸ Edit Contact');
    $('#saveBtn').text('ğŸ’¾ Update Contact');
    $('#cancelBtn').show();
    
    // Scroll to form
    $('html, body').animate({
        scrollTop: $('#contactForm').offset().top - 100
    }, 300);
}

// Cancel edit
$('#cancelBtn').click(() => resetForm());

// Reset form
function resetForm() {
    editingId = null;
    $('#contactForm')[0].reset();
    $('#contactId').val('');
    $('#formTitle').text('â• Add New Contact');
    $('#saveBtn').text('ğŸ’¾ Save Contact');
    $('#cancelBtn').hide();
}

// Delete contact - using index instead of inline string parameters
function deleteContact(index) {
    if (!contactsData[index]) {
        showToast('âŒ Contact not found', 'error');
        return;
    }
    
    const contact = contactsData[index];
    $('#deleteName').text(contact.name);
    $('#confirmDelete').data('id', contact.id);
    $('#deleteModal').modal('show');
}

// Confirm delete
$('#confirmDelete').click(function() {
    const id = $(this).data('id');
    const $btn = $(this);
    const originalText = $btn.text();
    
    $btn.prop('disabled', true).text('Deleting...');
    
    $.ajax({
        url: `/api/contacts/${id}`,
        method: 'DELETE',
        success: (response) => {
            console.log('Delete success:', response);
            $('#deleteModal').modal('hide');
            loadContacts();
            showToast('âœ… Contact deleted successfully!', 'success');
        },
        error: (xhr, status, error) => {
            console.error('Delete error:', xhr.responseText, status, error);
            let errorMsg = 'Error deleting contact';
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMsg = errorData.error || errorMsg;
            } catch(e) {
                errorMsg = xhr.responseText || error || errorMsg;
            }
            showToast('âŒ ' + errorMsg, 'error');
        },
        complete: () => {
            $btn.prop('disabled', false).text(originalText);
        }
    });
});

// Add some debugging
window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e.error);
    showToast('âŒ JavaScript Error: ' + e.message, 'error');
});
</script>
</body>
</html>
